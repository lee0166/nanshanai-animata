# 自定义模型添加规则说明文档

## 1 功能概述

自定义模型功能允许用户在 Settings 页面添加任意模型，不受预设模型列表限制。该功能通过开关切换实现预设模型与自定义模型的区分，自定义模型需要用户手动填写 Provider、Model ID 等关键信息。

自定义模型与预设模型的主要区别在于：预设模型通过 `templateId` 关联代码定义的默认配置，而自定义模型完全由用户输入的数据构成。系统对两种模型的保存和恢复采用不同的处理策略，以确保数据的完整性和可用性。

## 2 添加流程

### 2.1 基础操作步骤

用户在添加自定义模型时，需要按照以下顺序完成操作。首先进入 Settings 页面，在 Models 区域找到并点击「Add Model」按钮，此时会弹出一个卡片式表单。在表单顶部，用户需要通过 Select 组件选择模型类型，支持「Image」和「Video」两种类型。类型选择是必要操作，未选择类型时无法进行后续步骤。

完成类型选择后，用户需要打开表单中的「自定义模型」开关。该开关默认处于关闭状态，打开后会自动隐藏预设模型的 Provider 和 Base Model 选择区域，同时显示自定义模型的输入表单。开关下方有简短的说明文字，提示用户此功能用于添加任意模型，不受预设列表限制。

打开自定义模式后，用户需要填写三个字段。Provider 字段为必填项，用于指定模型提供商，格式示例为 `modelscope`、`openai`、`volcengine` 等。Model ID 字段为必填项，用于指定具体的模型标识符，格式示例为 `tongyi-diffusion`。API URL 字段为可选项，用于指定自定义的 API 端点地址，格式示例为 `https://api-inference.modelscope.cn/v1`。

最后，用户需要输入该模型的 API Key，并点击表单底部的「Add」按钮完成添加。系统会验证必填字段是否已填写，验证通过后将模型添加到全局模型列表中。添加成功后，表单会自动重置，为下一次添加做准备。

### 2.2 连接状态要求

添加模型的操作必须在已连接工作区的状态下执行。如果用户尚未连接工作区（显示「Disconnected」状态），系统会弹出错误提示，告知用户需要先连接工作区才能保存设置。这是因为自定义模型的配置数据需要持久化存储到 `settings.json` 文件中，而该文件只能存在于已连接的工作区目录或 Sandbox Mode 的 OPFS 存储中。

在 Sandbox Mode 下，系统使用浏览器的 Origin Private File System（OPFS）存储数据，无需用户手动选择目录。但即使在 Sandbox Mode 下，如果 `isConnected` 状态为 `false`，添加操作同样会被阻止。这种设计确保了数据的可靠性，避免用户在未建立有效存储连接的情况下误操作导致数据丢失。

## 3 技术实现规则

### 3.1 状态管理规则

自定义模型相关的状态在 `views/Settings.tsx` 文件中定义和管理。核心状态变量包括 `isCustomModel` 布尔值和 `customModel` 对象。`isCustomModel` 用于控制自定义模式开关的状态，反映当前是否处于自定义模型添加模式。`customModel` 对象包含三个属性：`provider` 存储提供商名称，`modelId` 存储模型标识符，`apiUrl` 存储可选的 API 地址。

状态初始化时，`isCustomModel` 默认设为 `false`，表示默认使用预设模型添加模式。`customModel` 对象的默认值设置为 `provider: 'modelscope'`、`modelId: ''`、`apiUrl: ''`。这样的默认值设计考虑到了 ModelScope 是较常用的提供商之一，预设默认值可以减少用户的输入操作。

在表单提交成功后，系统会自动重置相关状态，包括将 `isCustomModel` 设回 `false`，将 `customModel` 的所有字段清空。同时被清空的还包括 `newModelName`、`selectedType`、`selectedProvider`、`newApiKey` 等关联字段，确保下一次打开表单时处于干净的初始状态。

### 3.2 模型配置结构规则

自定义模型创建时生成的配置对象必须遵循 `ModelConfig` 类型定义。根据 `types.ts` 文件中的定义，一个完整的模型配置包含以下核心字段：`id` 为模型唯一标识符，通过 `crypto.randomUUID()` 生成或使用随机字符串回退；`name` 为模型显示名称，由用户输入；`provider` 为提供商名称；`modelId` 为模型标识符；`type` 为模型类型（`image` 或 `video`）；`apiKey` 为用户提供的 API 密钥；`apiUrl` 为可选的 API 地址。

自定义模型与预设模型的关键区别在于 `templateId` 字段。预设模型在创建时会设置 `templateId` 为对应模板模型的 `id`，用于后续从 `DEFAULT_MODELS` 恢复配置时进行匹配。而自定义模型不设置 `templateId` 字段，该字段保持为 `undefined`，这是系统区分两类模型的重要标志。

`capabilities` 字段对于自定义模型采用固定值 `{ maxBatchSize: 1, supportsReferenceImage: false }`。`parameters` 字段根据模型类型选择对应的参数模板：Image 类型使用 `COMMON_IMAGE_PARAMS`，Video 类型使用 `COMMON_VOLC_VIDEO_PARAMS`。这两个参数常量定义在 `config/models.ts` 文件中，分别包含图像模型和视频模型的通用参数配置。

### 3.3 保存机制规则

模型保存通过 `AppContext.updateSettings()` 方法触发，该方法接收新的 `AppSettings` 对象，更新全局状态，并调用 `storageService.saveSettings()` 方法将数据持久化。保存操作依赖工作区连接状态，如果 `storageService.isConnected()` 返回 `false`，则跳过实际的文件写入操作，并在控制台输出警告日志。

`storageService.saveSettings()` 方法在保存前会对模型数组进行裁剪（prune），移除运行时不需要的字段，只保留持久化必需的字段。裁剪后的模型对象包含以下字段：`id`、`templateId`（可能为 `undefined`）、`name`、`provider`、`modelId`、`type`、`apiUrl`（可能为 `undefined`）、`apiKey`、`isDefault`。这种裁剪策略有效控制了 `settings.json` 文件的大小，同时确保了所有必要信息的完整性。

保存操作将裁剪后的模型数组写入工作区根目录下的 `settings.json` 文件。文件格式为标准 JSON，模型数组存储在 `models` 键下。写入采用原子操作机制，通过创建临时文件再重命名的方式避免写入过程中断导致的数据损坏。

### 3.4 恢复机制规则

应用启动时调用 `storageService.loadSettings()` 方法加载已保存的设置。该方法读取 `settings.json` 文件内容并解析为 `AppSettings` 对象。恢复模型配置是一个「再水合」（rehydrate）过程，将存储的精简数据重新构建为完整的 `ModelConfig` 对象。

恢复逻辑首先检查每个模型的 `templateId` 字段。如果 `templateId` 存在且能在 `DEFAULT_MODELS` 数组中找到对应模板，系统会执行合并操作：先复制模板的完整配置，然后用存储的实例数据覆盖相应字段。这种设计允许预设模型的默认配置随代码更新而变化，同时保留用户对名称、API Key 等字段的自定义设置。

对于没有 `templateId` 的自定义模型，系统采用直接恢复策略：将存储的对象与默认的 `capabilities` 和 `parameters` 属性合并。`parameters` 的选择基于存储的 `type` 字段值：Image 类型使用 `COMMON_IMAGE_PARAMS`，Video 类型使用 `COMMON_VOLC_VIDEO_PARAMS`。这种策略确保了自定义模型在恢复后拥有完整的运行时配置结构。

恢复后的模型数组与 `DEFAULT_SETTINGS.models` 进行浅合并，生成最终的全局设置对象。合并策略确保了即使 `settings.json` 文件不存在或损坏，应用也能使用预设的默认模型配置正常启动。

## 4 关键文件说明

### 4.1 views/Settings.tsx

该文件包含自定义模型的 UI 组件和业务逻辑。主要职责包括：渲染模型列表、渲染添加表单、处理用户输入、管理本地状态、调用保存方法。文件中定义了 `handleAddCustomModel()` 函数，该函数负责验证输入、创建模型配置对象、更新全局状态，并在工作区未连接时抛出错误提示。

### 4.2 services/storage.ts

该文件包含所有持久化存储相关的逻辑。自定义模型的保存和恢复逻辑位于 `saveSettings()` 和 `loadSettings()` 两个方法中。`saveSettings()` 负责裁剪模型数据并写入 JSON 文件，`loadSettings()` 负责读取文件并重建完整的模型配置对象。该文件还导出了 `COMMON_IMAGE_PARAMS` 和 `COMMON_VOLC_VIDEO_PARAMS` 常量，供恢复逻辑使用。

### 4.3 contexts/AppContext.tsx

该文件定义了全局状态管理和上下文提供者。`updateSettings()` 方法是连接 UI 组件和存储服务的桥梁，负责在保存前检查工作区连接状态。`isConnected` 状态和 `checkConnection()` 方法用于确定当前是否已建立有效的存储连接。

### 4.4 config/models.ts

该文件定义了所有预设模型的配置模板，以及自定义模型恢复时所需的参数常量。`DEFAULT_MODELS` 数组包含所有预设模型的完整配置。`COMMON_IMAGE_PARAMS` 和 `COMMON_VOLC_VIDEO_PARAMS` 分别是图像模型和视频模型的默认参数列表，供自定义模型在恢复时使用。

### 4.5 types/index.ts

该文件定义了 `ModelConfig` 接口，规定了模型配置对象的类型结构。核心字段包括：`id`（字符串，唯一标识）、`name`（字符串，显示名称）、`provider`（字符串，提供商）、`modelId`（字符串，模型标识）、`type`（`image` 或 `video`）、`apiKey`（字符串，API 密钥）、`apiUrl`（可选字符串，API 地址）、`templateId`（可选字符串，关联的模板 ID）、`capabilities`（对象，模型能力）、`parameters`（数组，模型参数）、`isDefault`（布尔值，是否默认模型）。

## 5 常见问题与解决方案

### 5.1 模型添加后消失

**问题描述**：添加自定义模型后，刷新页面或重新打开应用，模型列表中不再显示新添加的模型。

**原因分析**：该问题通常由以下原因导致。第一，工作区未连接状态下添加模型，`updateSettings()` 跳过保存操作，数据仅存在于内存中。第二，连接状态检查逻辑存在缺陷，某些边界情况下 `isConnected` 返回不准确的值。第三，`settings.json` 文件写入失败，但 UI 未给出明确错误提示。第四，浏览器本地存储或 OPFS 存储异常，导致数据无法正确写入或读取。

**解决方案**：首先确认 Settings 页面的连接状态指示器显示为「Connected」（绿色）。如果显示为「Disconnected」（红色），需要先点击「Select Folder」连接工作区或启用 Sandbox Mode。其次检查浏览器控制台是否有 `[SETTINGS]` 或 `[STORAGE]` 相关的警告日志。如果写入失败，尝试切换到 Sandbox Mode 后重新添加模型。如果问题仍然存在，检查浏览器的文件系统权限设置。

### 5.2 保存时提示未连接

**问题描述**：添加模型时系统提示「Disconnected: 请选择一个文件夹来存储项目文件」，无法完成保存。

**原因分析**：该提示表明 `isConnected` 状态为 `false`，系统拒绝执行保存操作。可能原因包括：工作区从未建立连接、连接已过期、浏览器权限被撤销、Sandbox Mode 未正确初始化。

**解决方案**：在 Settings 页面的 Workspace 区域，检查当前工作区状态。如果显示「Disconnected」，点击「Select Folder」按钮选择一个新的空目录，或点击开关启用 Sandbox Mode。Sandbox Mode 使用浏览器内置的 OPFS 存储，无需用户手动选择目录。如果之前已连接但状态变为断开，尝试断开后重新连接，或清除浏览器存储后重试。

### 5.3 自定义模型无法使用

**问题描述**：模型已成功添加并显示在列表中，但在生成资源时选择该模型后报错或无响应。

**原因分析**：该问题可能由以下原因导致。第一，API Key 填写错误或权限不足，AI 服务拒绝请求。第二，Model ID 或 Provider 不匹配实际的 API 端点要求。第三，API URL 未填写或填写错误，导致请求发送到错误的地址。第四，模型配置恢复时参数不完整，缺少必要的参数定义。

**解决方案**：首先检查模型的 API Key 是否正确，可以尝试在官方接口工具中测试。其次确认 Model ID 的拼写和格式符合提供商的要求，不同提供商的 Model ID 格式可能不同。如果使用了自定义 API URL，确保该 URL 可访问且支持对应的模型。最后检查模型的 type 是否与实际用途匹配，Image 类型模型只能用于图像生成，Video 类型模型只能用于视频生成。

### 5.4 模型信息显示不完整

**问题描述**：模型列表中某些字段显示为空或不完整，如 Model ID 显示为空白。

**原因分析**：该问题通常发生在模型恢复阶段。可能原因包括：保存时数据裁剪逻辑遗漏了必要字段、恢复时合并逻辑存在缺陷、类型定义与实际数据结构不匹配。

**解决方案**：检查 `settings.json` 文件内容，确认模型数据是否正确保存。可以通过浏览器开发者工具的 Application 面板查看 OPFS 文件内容，或在本地工作区直接查看 JSON 文件。如果 JSON 文件中字段完整但 UI 显示空白，检查 `views/Settings.tsx` 中对应字段的渲染逻辑。如果 JSON 文件中字段缺失，检查 `services/storage.ts` 中的裁剪逻辑是否正确保留了所有必要字段。

### 5.5 预设模型无法再添加

**问题描述**：某些预设模型在添加表单中不再显示，无法再次添加相同的模型。

**原因分析**：系统设计了去重机制，通过检查 `templateId` 或 `id` 来过滤已添加的模型。如果某个预设模型已经被添加过，无论是预设模型还是自定义模型，其 ID 都会被加入排除集合，后续不会在可用模型列表中显示。

**解决方案**：如果需要添加同名的多个模型实例，目前需要通过自定义模型方式添加。在添加表单中选择相同类型，打开自定义模型开关，填写相同的 Provider 和 Model ID，但使用不同的显示名称。如果需要替换已添加的模型，需要先删除旧模型后再添加新模型。

## 6 相关日志关键字

调试自定义模型相关问题时，以下关键字可用于快速定位日志。`[SETTINGS]` 前缀的日志来自 `AppContext.tsx` 中的 `updateSettings()` 方法，用于标识设置保存相关的信息和警告。`[STORAGE]` 前缀的日志来自 `storageService` 的各种方法，用于标识存储操作、连接状态和文件读写相关信息。`[INIT]` 前缀的日志来自应用初始化逻辑，用于标识启动过程中的状态变化和问题。

在浏览器开发者工具的 Console 面板中搜索这些关键字，可以快速过滤出与自定义模型相关的日志，便于问题诊断和排查。
